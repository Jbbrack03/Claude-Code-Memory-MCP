#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

# Pre-commit hook for Claude Code Memory MCP Server
echo "🔍 Running pre-commit checks..."

# Get changed files (staged and modified)
CHANGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|js)$' | tr '\n' ' ')

if [ -z "$CHANGED_FILES" ]; then
    echo "✅ No TypeScript/JavaScript files changed, skipping tests"
    exit 0
fi

echo "📝 Changed files: $CHANGED_FILES"

# Run linting on changed files
echo "🔧 Running linter on changed files..."
npm run lint || {
    echo "❌ Linting failed. Please fix the issues before committing."
    exit 1
}

# Run type checking
echo "📋 Running type check..."
npm run typecheck || {
    echo "❌ Type checking failed. Please fix the issues before committing."
    exit 1
}

# Run tests related to changed files
echo "🧪 Running tests for changed files..."

# Create a test pattern based on changed source files
TEST_PATTERN=""
for file in $CHANGED_FILES; do
    # Convert src file path to test file path
    if echo "$file" | grep -q "^src/"; then
        # Convert src/module/file.ts to tests/module/file.test.ts pattern
        test_path=$(echo "$file" | sed 's|^src/|tests/|' | sed 's|\.ts$|\.test\.ts|' | sed 's|\.js$|\.test\.js|')
        
        # Also check for the directory pattern (e.g., tests/storage/ for src/storage/*)
        test_dir=$(dirname "$test_path")
        
        if [ -z "$TEST_PATTERN" ]; then
            TEST_PATTERN="$test_path|$test_dir"
        else
            TEST_PATTERN="$TEST_PATTERN|$test_path|$test_dir"
        fi
    elif echo "$file" | grep -q "^tests/"; then
        # If the changed file is already a test file
        if [ -z "$TEST_PATTERN" ]; then
            TEST_PATTERN="$file"
        else
            TEST_PATTERN="$TEST_PATTERN|$file"
        fi
    fi
done

if [ -n "$TEST_PATTERN" ]; then
    echo "🎯 Running targeted tests: $TEST_PATTERN"
    NODE_OPTIONS='--experimental-vm-modules' npm test -- --testPathPattern="$TEST_PATTERN" --no-coverage --maxWorkers=50% --detectOpenHandles --forceExit || {
        echo "❌ Tests failed. Please fix the issues before committing."
        exit 1
    }
else
    echo "🚀 Running timeout helper tests as fallback..."
    NODE_OPTIONS='--experimental-vm-modules' npm test -- --testPathPattern="test-helpers|test-cleanup-manager" --no-coverage --maxWorkers=50% --detectOpenHandles --forceExit || {
        echo "❌ Fallback tests failed. Please fix the issues before committing."
        exit 1
    }
fi

echo "✅ Pre-commit checks passed!"